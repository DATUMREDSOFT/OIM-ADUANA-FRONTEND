<mat-card class="cardWithShadow">
  <mat-card-header>
    <mat-card-title>Formulario de Solicitud</mat-card-title>
  </mat-card-header>
  <br/>
  <mat-card-content>
    <div class="row">
      <div class="col-lg-6">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Seleccione el tipo de solicitud</mat-label>
          <mat-select [(value)]="selectedSolicitud" (selectionChange)="onSolicitudChange($event)">
            <mat-option value="nuevoUsuario">Nuevo usuario</mat-option>
            <mat-option value="modificarUsuario">Modificar usuario</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <div class="col-lg-6 text-left flex items-center justify-center">
        <button mat-flat-button color="primary" (click)="addAnotherUser()">Agregar</button>
      </div>
    </div>
  </mat-card-content>
</mat-card>

<mat-accordion>
  <div *ngFor="let user of userRequests; let i = index" style="margin-bottom: 16px;">
    <mat-expansion-panel (opened)="editUser(i)">
      <mat-expansion-panel-header class="flex items-center justify-center">
        <mat-panel-title class="pr-4">
            <div>
            <strong>Solicitud {{ i + 1 }}: </strong>
            
            <span style="color:blue">{{ user.tipoSolicitud === 'nuevoUsuario' ? 'Nuevo usuario' : 'Modificar usuario' }}</span>
            </div>
        </mat-panel-title>
        <mat-panel-description class="w-auto">
          
        </mat-panel-description>
      </mat-expansion-panel-header>
      <form [formGroup]="userForm">
        <div class="row">
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>DUI/NIT</mat-label>
              <input matInput formControlName="duiNit">
              <button mat-icon-button matSuffix (click)="fetchUserData()">
                <mat-icon>search</mat-icon>
              </button>
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Nombre</mat-label>
              <input matInput formControlName="nombre">
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Apellido</mat-label>
              <input matInput formControlName="apellido">
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Usuario</mat-label>
              <input matInput formControlName="usuario">
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Correo</mat-label>
              <input matInput formControlName="correo">
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Organizaci√≥n</mat-label>
              <input matInput formControlName="organizacion" value="DGA" [disabled]="true">
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Estado</mat-label>
              <input matInput formControlName="estado">
            </mat-form-field>
          </div>
        </div>

        <mat-divider></mat-divider>

        <div class="row">
          <div class="col-lg-6">
            <h3>Perfiles</h3>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Perfil</mat-label>
              <mat-select formControlName="perfil">
                <mat-option value="perfil1">Perfil 1</mat-option>
                <mat-option value="perfil2">Perfil 2</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Aduana Perfil</mat-label>
              <mat-select formControlName="aduanaPerfil">
                <mat-option value="aduana1">Aduana 1</mat-option>
                <mat-option value="aduana2">Aduana 2</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Fecha Inicio Perfil</mat-label>
              <input matInput [matDatepicker]="picker1" formControlName="fechaInicioPerfil">
              <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
              <mat-datepicker #picker1></mat-datepicker>
            </mat-form-field>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Fecha Fin Perfil</mat-label>
              <input matInput [matDatepicker]="picker2" formControlName="fechaFinPerfil">
              <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
              <mat-datepicker #picker2></mat-datepicker>
            </mat-form-field>
            <button mat-flat-button color="primary" (click)="saveProfileAndSystem()">{{ editMode ? 'Actualizar' : 'Guardar' }} perfil y sistema</button>
          </div>
          <div class="col-lg-1">
            <div class="vertical-divider"></div>
          </div>
          <div class="col-lg-5">
            <h3>Sistemas</h3>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Sistema</mat-label>
              <mat-select formControlName="sistema">
                <mat-option value="sistema1">Sistema 1</mat-option>
                <mat-option value="sistema2">Sistema 2</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Aduana Sistema</mat-label>
              <mat-select formControlName="aduanaSistema">
                <mat-option value="aduana1">Aduana 1</mat-option>
                <mat-option value="aduana2">Aduana 2</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Fecha Inicio Sistema</mat-label>
              <input matInput [matDatepicker]="picker3" formControlName="fechaInicioSistema">
              <mat-datepicker-toggle matSuffix [for]="picker3"></mat-datepicker-toggle>
              <mat-datepicker #picker3></mat-datepicker>
            </mat-form-field>
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Fecha Fin Sistema</mat-label>
              <input matInput [matDatepicker]="picker4" formControlName="fechaFinSistema">
              <mat-datepicker-toggle matSuffix [for]="picker4"></mat-datepicker-toggle>
              <mat-datepicker #picker4></mat-datepicker>
            </mat-form-field>
          </div>
          
        </div>

        <div class="row">
          <div class="col-lg-6">
            <h4>Perfiles Asignados</h4>
            <ul>
              <li *ngFor="let perfil of perfilesAsignados; let j = index">
                {{ perfil.perfil }} - {{ perfil.aduana }} - Inicio:{{ perfil.fechaInicio || 'N/A' }} - Fin:{{ perfil.fechaFin || 'N/A' }}
                <button mat-icon-button color="primary" (click)="editPerfil(j)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deletePerfil(j)">
                  <mat-icon>delete</mat-icon>
                </button>
              </li>
            </ul>
          </div>
          <div class="col-lg-6">
            <h4>Sistemas Asignados</h4>
            <ul>
              <li *ngFor="let sistema of sistemasAsignados; let k = index">
                {{ sistema.sistema }} - {{ sistema.aduana }}
                <button mat-icon-button color="primary" (click)="editSistema(k)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteSistema(k)">
                  <mat-icon>delete</mat-icon>
                </button>
              </li>
            </ul>
          </div>
          
        </div>

        <div class="text-right m-t-16">
          
          <button mat-flat-button color="primary" (click)="saveCurrentUser()">Guardar usuario</button>
          <button mat-flat-button color="warn" (click)="confirmDeleteUser(i)" style="margin-left: 8px;">Borrar usuario</button>
        </div>
      </form>
    </mat-expansion-panel>
  </div>
  <div class="m-t-16 d-flex justify-content-between">
    <button mat-flat-button color="primary" (click)="sendRequest()">Guardar</button>
    <button mat-flat-button color="accent" (click)="sendRequest()">Enviar solicitud</button>
  </div>
</mat-accordion>